name: ğŸ‰ First-Time Contributor Welcome

on:
  pull_request_target:
    types: [opened]
  issues:
    types: [opened]

permissions:
  pull-requests: write
  issues: write

jobs:
  welcome:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: ğŸ‘‹ Welcome new contributors
      if: github.event_name == 'pull_request_target'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          const prAuthor = context.payload.pull_request.user.login;

          // Check if this is their first contribution
          const { data: userPRs } = await github.rest.search.issuesAndPullRequests({
            q: `author:${prAuthor} repo:${owner}/${repo} type:pr`,
            per_page: 2
          });

          const isFirstTime = userPRs.items.length === 1;

          if (isFirstTime) {
            const welcomeMessage = [
              'ğŸ‰ **Welcome to Student Fest!** @' + prAuthor,
              '',
              'Thank you for your first contribution to our interactive project! ğŸš€',
              '',
              '## ğŸŒŸ What happens next:',
              '1. **Automated Testing**: Our CI will test your code automatically',
              '   - âœ… If tests pass, you\'ll see green checkmarks',
              '   - âŒ If tests fail, don\'t worry! You can fix them by pushing more commits',
              '2. **Review Process**: A maintainer will review your contribution within 24-48 hours',
              '3. **Feedback & Changes**: We might suggest some improvements',
              '   - This is normal and helps you learn!',
              '   - Just push more commits to address feedback',
              '4. **Badge Generation**: Once merged, you\'ll earn achievement badges! ğŸ†',
              '5. **Community Recognition**: Your profile will be featured in our contributors gallery',
              '',
              '## ğŸ“š Essential Resources for new contributors:',
              '- ğŸ“– **[Contribution Guide](https://github.com/' + owner + '/' + repo + '/blob/main/CONTRIBUTING.md)** - Start here!',
              '- ğŸ”§ **[Git Basics](https://github.com/' + owner + '/' + repo + '/blob/main/docs/guides/GIT_BASICS.md)** - Learn Git commands',
              '- ğŸ’» **[Setup Instructions](https://github.com/' + owner + '/' + repo + '/blob/main/docs/guides/SETUP.md)** - Local development setup',
              '- ğŸ† **[Achievement System](https://github.com/' + owner + '/' + repo + '/blob/main/docs/guides/ACHIEVEMENTS.md)** - Track your progress',
              '- â“ **[FAQ](https://github.com/' + owner + '/' + repo + '/blob/main/docs/guides/FAQ.md)** - Common questions answered',
              '',
              '## ğŸ¯ Quick Tips for Success:',
              '- âœ… **Test locally** before pushing - saves time!',
              '- âœ… **Read feedback carefully** - it\'s meant to help you improve',
              '- âœ… **Ask questions** - there are no "dumb" questions here!',
              '- âœ… **Be patient** - reviews take time, we\'re all volunteers',
              '- âœ… **Check CI results** - they help catch issues early',
              '- âœ… **Update your PR** - you can push more commits anytime',
              '',
              '## ğŸ› Common First-Time Issues & Solutions:',
              '',
              '**âŒ Tests failing?**',
              '- Check the CI logs (click on the red X)',
              '- Fix the issues locally',
              '- Push your fixes: `git add . && git commit -m "fix: address CI feedback" && git push`',
              '',
              '**âŒ Merge conflicts?**',
              '- Sync with main: `git pull origin main`',
              '- Resolve conflicts in your editor',
              '- Commit and push',
              '',
              '**âŒ Need to make changes?**',
              '- Just make your edits',
              '- Commit and push again',
              '- Your PR will update automatically!',
              '',
              '## ğŸ’¬ Need Help?',
              '- ğŸ’¬ Comment on this PR with your questions',
              '- ğŸ·ï¸ Use the `help wanted` label',
              '- ğŸ“– Check our [Discussions](https://github.com/' + owner + '/' + repo + '/discussions)',
              '',
              '---',
              '',
              'Keep coding and welcome to the open source community! We\'re excited to have you here! ğŸŒâœ¨',
              '',
              '*Remember: Every expert was once a beginner who kept going.* ğŸ’ª'
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: welcomeMessage
            });
          }

    - name: ğŸ·ï¸ Add contribution labels
      if: github.event_name == 'pull_request_target'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          const prFiles = context.payload.pull_request.changed_files;

          const labels = [];

          // Determine contribution type based on files changed
          if (prFiles.some(file => file.filename.startsWith('profiles/'))) {
            labels.push('profile');
          }
          if (prFiles.some(file => file.filename.startsWith('challenges/'))) {
            labels.push('challenge');
          }
          if (prFiles.some(file => file.filename.startsWith('projects/'))) {
            labels.push('project');
          }
          if (prFiles.some(file => file.filename.startsWith('scripts/'))) {
            labels.push('script');
          }

          // Add difficulty level
          const prTitle = context.payload.pull_request.title.toLowerCase();
          if (prTitle.includes('beginner') || prFiles.some(file => file.filename.includes('beginner'))) {
            labels.push('beginner-friendly');
          }
          if (prTitle.includes('intermediate') || prFiles.some(file => file.filename.includes('intermediate'))) {
            labels.push('intermediate');
          }
          if (prTitle.includes('advanced') || prFiles.some(file => file.filename.includes('advanced'))) {
            labels.push('advanced');
          }

          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels
            });
          }

  issue-welcome:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'

    steps:
    - name: ğŸ’¬ Welcome issue creators
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const issueNumber = context.payload.issue.number;
          const issueAuthor = context.payload.issue.user.login;
          const issueTitle = context.payload.issue.title;

          const issueWelcomeMessage = [
            'ğŸ‘‹ **Thanks for opening an issue!** @' + issueAuthor,
            '',
            'We appreciate you taking the time to report this and help improve Student Fest! ğŸ¯',
            '',
            '## ğŸ“‹ Issue Details:',
            '**Title**: ' + issueTitle,
            '',
            '## ğŸ”„ What Happens Next:',
            '1. **Triage** - A maintainer will review and label your issue (usually within 24-48 hours)',
            '2. **Discussion** - We might ask for clarification or more details',
            '3. **Assignment** - If it\'s a valid issue, someone will work on it',
            '4. **Resolution** - A PR will be created to address the issue',
            '',
            '## ğŸ’¡ Help Us Help You:',
            '',
            '### ğŸ› If this is a **Bug Report**, please include:',
            '- âœ… Clear steps to reproduce the issue',
            '- âœ… What you expected to happen',
            '- âœ… What actually happened',
            '- âœ… Your environment (OS, browser, versions)',
            '- âœ… Screenshots or error messages if applicable',
            '',
            '### âœ¨ If this is a **Feature Request**, please include:',
            '- âœ… Why this feature would be valuable',
            '- âœ… How you envision it working',
            '- âœ… Any examples or mockups',
            '- âœ… Who would benefit from it',
            '',
            '### â“ If this is a **Question**, consider:',
            '- ğŸ“– Checking our [FAQ](https://github.com/' + owner + '/' + repo + '/blob/main/docs/guides/FAQ.md)',
            '- ğŸ’¬ Using [Discussions](https://github.com/' + owner + '/' + repo + '/discussions) instead',
            '- ğŸ” Searching existing issues',
            '',
            '## ğŸš€ Want to Work on This?',
            'If you\'d like to fix this issue yourself:',
            '1. Comment below: "I\'d like to work on this!"',
            '2. Wait for a maintainer to assign it to you',
            '3. Fork the repo and create a branch',
            '4. Submit a PR when ready!',
            '',
            '**First time contributing?** Check out our [Contribution Guide](https://github.com/' + owner + '/' + repo + '/blob/main/CONTRIBUTING.md)!',
            '',
            '---',
            '',
            'Thanks again for contributing to Student Fest! Every issue helps make this project better. ğŸ™âœ¨'
          ].join('\n');

          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: issueNumber,
            body: issueWelcomeMessage
          });
