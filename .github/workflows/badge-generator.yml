name: ğŸ† Badge Generator & Stats

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [closed]

permissions:
  contents: write

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.merged == true

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install dependencies
      run: |
        pip install Pillow requests PyYAML

    - name: ğŸ“Š Run existing analysis scripts
      run: |
        # Only run scripts that exist
        if [ -f "scripts/analyze_contributions.py" ]; then
          python scripts/analyze_contributions.py || echo "Analysis script encountered an issue"
        fi

        if [ -f "scripts/generate_badges.py" ]; then
          python scripts/generate_badges.py || echo "Badge generation script encountered an issue"
        fi

        if [ -f "scripts/validate_contributions.py" ]; then
          python scripts/validate_contributions.py || echo "Validation script encountered an issue"
        fi

    - name: ğŸš€ Upload artifacts (if any generated)
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: contribution-stats
        path: |
          badges/
          stats/
        if-no-files-found: ignore

  update-readme-stats:
    runs-on: ubuntu-latest
    needs: generate-stats
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“Š Generate contributor stats badge
      uses: wow-actions/contributors-svg@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        path: 'CONTRIBUTORS.svg'

    - name: ğŸ“ Commit updated stats
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "docs: update contribution statistics [skip ci]"
        file_pattern: "CONTRIBUTORS.svg README.md"
